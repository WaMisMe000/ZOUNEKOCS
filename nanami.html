<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å®šå‹æ–‡ãƒ©ãƒ³ãƒãƒ£ãƒ¼</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; background-color: #F4F4F6; }
    /* ã‚¿ãƒ– */
    #tabs { display: flex; gap: 0.3rem; flex: 1; }
    .tabs { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 0.3rem; padding: 0.2rem 0; margin-bottom: 0.5rem; align-items: center; width: 100%; scrollbar-width: thin; scrollbar-color: #ccc transparent; flex-shrink: 0; }
    .tab { background-color: white; white-space: nowrap; padding: 0.3rem 0.8rem; border: 1px solid #ccc; cursor: pointer; border-radius: 6px; font-size: 14px; }
    .tab.active { background: #7AA6A8; color: #fff; font-weight: bold; }
    .tab.new-tab { flex-shrink: 0; background-color: #7AA6A8; color: white; font-weight: bold; font-size: 17px; padding: 0.2em 0.4em; border-radius: 6px; border: none; cursor: pointer; }

    /* ï¼‹ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆåŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã€‚å®Ÿè¡¨ç¤ºã¯ body ç›´ä¸‹ã«å›ºå®šè¡¨ç¤ºï¼‰*/
    .plus-wrapper { position: relative; flex-shrink: 0; }
    .plus-menu {
      position: fixed; /* â† body ç›´ä¸‹ã§å›ºå®šé…ç½®ï¼ˆãƒãƒ¼ã‚¿ãƒ«ï¼‰ */
      min-width: 170px; background: #fff; border: 1px solid #ddd; border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12); padding: 6px; display: none; z-index: 9999;
    }
    .plus-menu.show { display: block; }
    .plus-item {
      display: block; width: 100%; text-align: left; background: none; border: none;
      border-radius: 6px; padding: 10px 12px; font-size: 13px; cursor: pointer;
    }
    .plus-item:hover { background: #F4F4F6; }

    /* ãƒœã‚¿ãƒ³ç¾¤ */
    .buttons { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem; margin-bottom: 1rem; }
    .button-wrapper { position: relative; overflow: hidden; }
    .button-main {
      background-color: #FDFDFE; border: 1px solid #ccc; padding: 0.6rem 0.8rem; border-radius: 6px;
      width: 100%; font-size: 13px; cursor: pointer; text-align: left; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .button-main .content {
      font-size: 12px; color: #777; margin-top: 2px; line-height: 1.2em;
      display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; max-height: 3.6em; -webkit-line-clamp: 3; min-height: 3.6em;
    }
    .button-main.expanded .content { max-height: none; -webkit-line-clamp: unset; white-space: normal; }
    .button-main .expand-icon { font-size: 10px; color: #999; position: absolute; right: 6px; bottom: 6px; pointer-events: none; }
    .menu-button { position: absolute; top: 4px; right: 4px; background: none; border: none; cursor: pointer; font-size: 16px; color: #999; z-index: 1; }
    .menu-button:hover { color: #333; }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
    .actions { margin-top: 1rem; display: flex; gap: 1rem; }
    .actions button { padding: 0.5rem 1rem; font-size: 14px; cursor: pointer; }
    textarea { width: 100%; height: 280px; font-size: 14px; padding: 1rem; box-sizing: border-box; resize: none; }

    /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
    .palette { display: flex; gap: 4px; align-items: center; flex-wrap: nowrap; }
    .swatch { width: 28px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 0 0 1px rgba(0,0,0,0.06) inset; }
    .swatch.active { border-color: #333; }

    /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
    .delete-btn { background: none; border: none; color: #c00; cursor: pointer; font-size: 18px; }
    .delete-btn:hover { color: #900; }
  </style>
</head>
<body>
  <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 80vh;">
    <!-- ã‚¿ãƒ– + ï¼‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒœã‚¿ãƒ³è‡ªä½“ã¯ã“ã“ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœ¬ä½“ã¯ body ç›´ä¸‹ã«å‡ºã™ï¼‰ -->
    <div class="tabs" id="tabs-wrapper">
      <div id="tabs"></div>
      <div class="plus-wrapper">
        <button id="plusBtn" class="tab new-tab" aria-haspopup="true" aria-expanded="false">ï¼‹</button>
      </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³ã‚¾ãƒ¼ãƒ³ -->
    <div class="buttons-resizable" style="position: relative;">
      <div class="buttons-container" style="flex: 1; overflow-y: auto; max-height: calc(3.6em * 3 + 2rem); margin-bottom: 0.5rem;">
        <div class="buttons" id="buttons"></div>
      </div>
      <div class="resizer" style="height: 2px; cursor: row-resize; background: #7AA6A8; margin: 12px 0;"></div>
    </div>

    <!-- ã‚¨ãƒ‡ã‚£ã‚¿ -->
    <div class="editor-container" style="position: relative; top: -18px;">
      <textarea id="editor" placeholder="ã“ã“ã«å®šå‹æ–‡ãŒè¿½åŠ ã•ã‚Œã¦ã„ãã¾ã™..." style="height: 420px;"></textarea>
      <div class="editor-resizer" style="height: 2px; background: #7AA6A8; cursor: row-resize; margin: 12px 0;"></div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="actions" style="margin-top: -0.9rem; display: flex; justify-content: space-between;">
      <button onclick="clearText()" style="background: #eee; border: 1px solid #ccc; border-radius: 6px;">ã‚¯ãƒªã‚¢</button>
      <div style="flex: 1"></div>
      <button onclick="copyText()" style="background: #7AA6A8; color: #fff; border: none; border-radius: 6px;">ã‚³ãƒ”ãƒ¼</button>
    </div>

    <script>
      const GAS_URL = "https://script.google.com/macros/s/AKfycbzUODweFan9H0_p3iR5mlb66xqmlmlEnzi6gcpTo-Ubf2yd04w8lkaGE2UM9JsC1-nJ/exec";
      let config = {};
      let currentTab = '';
      let currentEditIndex = null;

      /* ========== å…±é€š: GAS IO ========== */
      function fetchConfigFromGAS(){
        return fetch(GAS_URL).then(r=>r.json()).then(data=>{
          const next = {};
          for(const k in data){ next[k]=(data[k]||[]).map(row=>Array.isArray(row)?[row[0],row[1],row[2]]:row); }
          return next;
        });
      }
      function saveSheetToGAS(sheetName){
        return fetch(GAS_URL,{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ sheetName, data: JSON.stringify(config[sheetName]||[]) })
        });
      }
      function createEmptySheetOnGAS(sheetName){
        // GAS å´ãŒæœªä½œæˆãªã‚‰ã“ã® POST ã§ä½œã‚‹æƒ³å®šï¼ˆåŒã˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
        return fetch(GAS_URL,{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ sheetName, data: JSON.stringify([]) })
        });
      }

      /* ========== ã‚¿ãƒ– & ãƒœã‚¿ãƒ³ ========== */
      function renderTabs() {
        const tabContainer = document.getElementById('tabs');
        tabContainer.innerHTML = '';
        Object.keys(config).forEach(group => {
          const tab = document.createElement('div');
          tab.className = 'tab' + (group === currentTab ? ' active' : '');
          tab.textContent = group;
          tab.onclick = () => { currentTab = group; renderTabs(); renderButtons(); };
          tabContainer.appendChild(tab);
        });
      }
      function renderButtons() {
        const modal = document.getElementById('modal');
        if (modal) modal.style.display = 'none';

        const btnContainer = document.getElementById('buttons');
        btnContainer.innerHTML = '';
        (config[currentTab] || []).forEach((row, index) => {
          const label = row[0], content = row[1], color = row[2] || '#f9f9f9';

          const wrapper = document.createElement('div');
          wrapper.className = 'button-wrapper';

          const btn = document.createElement('button');
          btn.className = 'button-main';
          btn.style.background = color;
          btn.innerHTML = `<span class='label'>${label}</span><span class='content'>${content.replace(/\n/g,'<br>')}</span>`;

          const expandIcon = document.createElement('span');
          expandIcon.className = 'expand-icon';
          expandIcon.textContent = 'â–¼';
          btn.appendChild(expandIcon);

          btn.onclick = () => insertText(content);

          const menuBtn = document.createElement('button');
          menuBtn.className = 'menu-button';
          menuBtn.textContent = 'â€¦';
          menuBtn.onclick = (e) => {
            e.stopPropagation(); currentEditIndex = index;
            document.getElementById('editLabel').value = label;
            document.getElementById('editContent').value = content;
            document.getElementById('editColor').value = color;
            renderColorPalette(color);
            document.getElementById('modal').style.display = 'flex';
          };

          wrapper.appendChild(menuBtn);
          wrapper.appendChild(btn);
          btnContainer.appendChild(wrapper);
        });
      }

      /* ========== ã‚¨ãƒ‡ã‚£ã‚¿æ“ä½œ ========== */
      function insertText(text){ const e=document.getElementById('editor'); e.value += (e.value?'\n\n':'') + text; }
      function copyText(){
        const t=document.getElementById('editor').value;
        if(!navigator.clipboard){ alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ'); return; }
        navigator.clipboard.writeText(t).then(()=>{
          const msg=document.createElement('div');
          msg.textContent='ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
          Object.assign(msg.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#333',color:'#fff',padding:'0.6rem 1rem',borderRadius:'6px',zIndex:10000,fontSize:'14px'});
          document.body.appendChild(msg); setTimeout(()=>msg.remove(),1500);
        });
      }
      function clearText(){ document.getElementById('editor').value=''; }
      function closeModal(){ document.getElementById('modal').style.display='none'; }

      /* ========== ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜/å‰Šé™¤ ========== */
      async function saveEdit(){
        const l=document.getElementById('editLabel').value.trim(),
              c=document.getElementById('editContent').value,
              col=document.getElementById('editColor').value;
        if(!l){ alert('ãƒ©ãƒ™ãƒ«ã¯å¿…é ˆã§ã™'); return; }
        if(!currentTab){ alert('å…ˆã«ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„'); return; }
        if(!config[currentTab]) config[currentTab]=[];
        if(currentEditIndex!==null) config[currentTab][currentEditIndex]=[l,c,col];
        else config[currentTab].push([l,c,col]);

        renderButtons(); closeModal();
        await saveSheetToGAS(currentTab).catch(()=>alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼'));
        // ã‚µãƒ¼ãƒç¢ºå®šã‚’å†èª­è¾¼ã§åæ˜ 
        config = await fetchConfigFromGAS().catch(()=>config);
        renderTabs(); renderButtons();
      }
      async function deleteTemplate(){
        if(currentEditIndex!==null && confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
          config[currentTab].splice(currentEditIndex,1);
          renderButtons(); closeModal();
          await saveSheetToGAS(currentTab).catch(()=>alert('å‰Šé™¤ä¿å­˜ã‚¨ãƒ©ãƒ¼'));
          config = await fetchConfigFromGAS().catch(()=>config);
          renderTabs(); renderButtons();
        }
      }

      /* ========== ã‚«ãƒ†ã‚´ãƒªè¿½åŠ  ========== */
      function sanitizeSheetName(name){ return name.replace(/[:\\/?*\\[\\]]/g,'').trim(); }
      async function addNewCategory(){
        let name = prompt('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãŠè©«ã³/é…å»¶ï¼‰');
        if(name===null) return;
        name = sanitizeSheetName(name);
        if(!name){ alert('ã‚«ãƒ†ã‚´ãƒªåãŒç©ºã§ã™'); return; }
        if(config[name]){ alert('åŒåã®ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã™'); return; }

        // å…ˆã«ãƒ­ãƒ¼ã‚«ãƒ«ä½œæˆã—ã¦UXã‚’æ—©ã
        config[name]=[];
        currentTab=name;
        renderTabs(); renderButtons();

        // ã‚·ãƒ¼ãƒˆä½œæˆï¼ˆGAS å´ãŒæ–°è¦ã‚¿ãƒ–ä½œæˆã«å¯¾å¿œã—ã¦ã„ã‚Œã°ä½œã‚‰ã‚Œã‚‹æƒ³å®šï¼‰
        await createEmptySheetOnGAS(name).catch(()=>alert('ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒ©ãƒ¼'));

        // å¿µã®ãŸã‚ã‚µãƒ¼ãƒçŠ¶æ…‹ã‚’å†èª­è¾¼ï¼ˆã“ã“ã§æœ¬å½“ã«ä½œã‚‰ã‚ŒãŸã‹ç¢ºèªï¼‰
        config = await fetchConfigFromGAS().catch(()=>config);
        if(!config[name]){ config[name]=[]; } // å¤±æ•—æ™‚ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ç¶­æŒ
        currentTab = name;
        renderTabs(); renderButtons();
      }

      /* ========== ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ ========== */
      function renderColorPalette(selected){
        const palette=['#DCEBF2','#F3D8D5','#FAE3E1','#E9D8C9','#F8EDEB','#D6E2E9','#E3DFFF','#D8EBD8','#FFF3D6','#FAD2CF'];
        const container=document.getElementById('colorPalette');
        container.innerHTML='';
        palette.forEach(col=>{
          const d=document.createElement('div');
          d.className='swatch'+(col===selected?' active':'');
          d.style.background=col;
          d.title=col;
          d.onclick=()=>{ document.getElementById('editColor').value=col; renderColorPalette(col); };
          container.appendChild(d);
        });
      }

      /* ========== åˆæœŸãƒ­ãƒ¼ãƒ‰ ========== */
      (async function init(){
        try{
          config = await fetchConfigFromGAS();
        }catch(e){
          alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: '+e);
          config = { 'æœªåˆ†é¡': [] };
        }
        if(Object.keys(config).length===0) config['æœªåˆ†é¡']=[];
        currentTab = Object.keys(config)[0];
        renderTabs(); renderButtons();
      })();

      /* ========== ãƒªã‚µã‚¤ã‚ºï¼ˆãƒœã‚¿ãƒ³é ˜åŸŸï¼‰ ========== */
      document.addEventListener('DOMContentLoaded',()=>{
        const resizer=document.querySelector('.resizer');
        const container=document.querySelector('.buttons-container');
        let startY,startHeight;
        resizer.addEventListener('mousedown',e=>{
          startY=e.clientY; startHeight=parseInt(getComputedStyle(container).height,10);
          document.documentElement.addEventListener('mousemove',doDrag);
          document.documentElement.addEventListener('mouseup',stopDrag);
        });
        function doDrag(e){ container.style.maxHeight=`${startHeight+e.clientY-startY}px`; }
        function stopDrag(){ document.documentElement.removeEventListener('mousemove',doDrag); document.documentElement.removeEventListener('mouseup',stopDrag); }
      });

      /* ========== ï¼‹ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒãƒ¼ã‚¿ãƒ«è¡¨ç¤ºï¼‰ ========== */
      (function setupPlusMenu(){
        const btn = document.getElementById('plusBtn');

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœ¬ä½“ã¯ body ç›´ä¸‹ã«ä½œã‚‹ï¼ˆoverflow ã®å½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰
        const menu = document.createElement('div');
        menu.id = 'plusMenu';
        menu.className = 'plus-menu';
        menu.innerHTML = `
          <button class="plus-item" role="menuitem" id="miAddTpl">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ </button>
          <button class="plus-item" role="menuitem" id="miAddCat">ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </button>
        `;
        document.body.appendChild(menu);

        function openMenu(){
          const r = btn.getBoundingClientRect();
          // å³å¯„ã›ã§ãƒœã‚¿ãƒ³ã®ä¸‹ã«å›ºå®šé…ç½®
          const menuWidth = 190; // ã ã„ãŸã„
          const left = Math.max(12, r.right - menuWidth);
          const top  = r.bottom + 6;
          menu.style.left = left + 'px';
          menu.style.top  = top  + 'px';
          menu.style.width = menuWidth + 'px';
          menu.classList.add('show');
          btn.setAttribute('aria-expanded','true');
        }
        function closeMenu(){
          menu.classList.remove('show');
          btn.setAttribute('aria-expanded','false');
        }
        window.closePlusMenu = closeMenu;

        btn.addEventListener('click',(e)=>{ e.stopPropagation(); menu.classList.contains('show') ? closeMenu() : openMenu(); });
        document.addEventListener('click',(e)=>{ if(menu.classList.contains('show') && !e.target.closest('#plusMenu')) closeMenu(); });
        document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeMenu(); });

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®
        menu.querySelector('#miAddTpl').addEventListener('click',()=>{ addNewTemplate(); closeMenu(); });
        menu.querySelector('#miAddCat').addEventListener('click',()=>{ addNewCategory(); closeMenu(); });
      })();

      /* ========== æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬èµ·å‹• ========== */
      function addNewTemplate(){
        if(!currentTab){
          alert('ã¾ãšã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„');
          return;
        }
        currentEditIndex = null;
        document.getElementById('editLabel').value='';
        document.getElementById('editContent').value='';
        document.getElementById('editColor').value='#f9f9f9';
        renderColorPalette('#f9f9f9');
        document.getElementById('modal').style.display='flex';
      }
    </script>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="modal" onclick="closeModal()" style="display:none; position: fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
      <div class="modal-content" style="background:white; padding:1rem; border-radius:8px; width:320px; display:flex; flex-direction:column; gap:0.6rem; position:relative;" onclick="event.stopPropagation();">
        <input id="editLabel" placeholder="ãƒ©ãƒ™ãƒ«">
        <textarea id="editContent" rows="4" placeholder="å†…å®¹"></textarea>
        <div class="palette" id="colorPalette"></div>
        <input type="color" id="editColor" value="#f9f9f9" style="width:32px; height:32px; border:none; border-radius:50%; cursor:pointer;">

        <div style="display:flex; justify-content:space-between; align-items:center;">
          <button class="delete-btn" onclick="deleteTemplate()" title="å‰Šé™¤">ğŸ—‘ï¸</button>
          <div style="display:flex; gap:0.5rem;">
            <button onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="saveEdit()">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
