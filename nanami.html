<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>定型文ランチャー</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; background-color: #F4F4F6; }
    /* タブ */
    #tabs { display: flex; gap: 0.3rem; flex: 1; }
    .tabs { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 0.3rem; padding: 0.2rem 0; margin-bottom: 0.5rem; align-items: center; width: 100%; scrollbar-width: thin; scrollbar-color: #ccc transparent; flex-shrink: 0; }
    .tab { background-color: white; white-space: nowrap; padding: 0.3rem 0.8rem; border: 1px solid #ccc; cursor: pointer; border-radius: 6px; font-size: 14px; }
    .tab.active { background: #7AA6A8; color: #fff; font-weight: bold; }
    .tab.new-tab { flex-shrink: 0; background-color: #7AA6A8; color: white; font-weight: bold; font-size: 17px; padding: 0.2em 0.4em; border-radius: 6px; border: none; cursor: pointer; }

    /* ＋サブメニュー（基本スタイル。実表示は body 直下に固定表示）*/
    .plus-wrapper { position: relative; flex-shrink: 0; }
    .plus-menu {
      position: fixed; /* ← body 直下で固定配置（ポータル） */
      min-width: 170px; background: #fff; border: 1px solid #ddd; border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12); padding: 6px; display: none; z-index: 9999;
    }
    .plus-menu.show { display: block; }
    .plus-item {
      display: block; width: 100%; text-align: left; background: none; border: none;
      border-radius: 6px; padding: 10px 12px; font-size: 13px; cursor: pointer;
    }
    .plus-item:hover { background: #F4F4F6; }

    /* ボタン群 */
    .buttons { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem; margin-bottom: 1rem; }
    .button-wrapper { position: relative; overflow: hidden; }
    .button-main {
      background-color: #FDFDFE; border: 1px solid #ccc; padding: 0.6rem 0.8rem; border-radius: 6px;
      width: 100%; font-size: 13px; cursor: pointer; text-align: left; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .button-main .content {
      font-size: 12px; color: #777; margin-top: 2px; line-height: 1.2em;
      display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; max-height: 3.6em; -webkit-line-clamp: 3; min-height: 3.6em;
    }
    .button-main.expanded .content { max-height: none; -webkit-line-clamp: unset; white-space: normal; }
    .button-main .expand-icon { font-size: 10px; color: #999; position: absolute; right: 6px; bottom: 6px; pointer-events: none; }
    .menu-button { position: absolute; top: 4px; right: 4px; background: none; border: none; cursor: pointer; font-size: 16px; color: #999; z-index: 1; }
    .menu-button:hover { color: #333; }

    /* アクション／テキストエリア */
    .actions { margin-top: 1rem; display: flex; gap: 1rem; }
    .actions button { padding: 0.5rem 1rem; font-size: 14px; cursor: pointer; }
    textarea { width: 100%; height: 280px; font-size: 14px; padding: 1rem; box-sizing: border-box; resize: none; }

    /* カラーパレット */
    .palette { display: flex; gap: 4px; align-items: center; flex-wrap: nowrap; }
    .swatch { width: 28px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 0 0 1px rgba(0,0,0,0.06) inset; }
    .swatch.active { border-color: #333; }

    /* 削除ボタン */
    .delete-btn { background: none; border: none; color: #c00; cursor: pointer; font-size: 18px; }
    .delete-btn:hover { color: #900; }
  </style>
</head>
<body>
  <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 80vh;">
    <!-- タブ + ＋メニュー（ボタン自体はここ。メニュー本体は body 直下に出す） -->
    <div class="tabs" id="tabs-wrapper">
      <div id="tabs"></div>
      <div class="plus-wrapper">
        <button id="plusBtn" class="tab new-tab" aria-haspopup="true" aria-expanded="false">＋</button>
      </div>
    </div>

    <!-- ボタンゾーン -->
    <div class="buttons-resizable" style="position: relative;">
      <div class="buttons-container" style="flex: 1; overflow-y: auto; max-height: calc(3.6em * 3 + 2rem); margin-bottom: 0.5rem;">
        <div class="buttons" id="buttons"></div>
      </div>
      <div class="resizer" style="height: 2px; cursor: row-resize; background: #7AA6A8; margin: 12px 0;"></div>
    </div>

    <!-- エディタ -->
    <div class="editor-container" style="position: relative; top: -18px;">
      <textarea id="editor" placeholder="ここに定型文が追加されていきます..." style="height: 420px;"></textarea>
      <div class="editor-resizer" style="height: 2px; background: #7AA6A8; cursor: row-resize; margin: 12px 0;"></div>
    </div>

    <!-- アクション -->
    <div class="actions" style="margin-top: -0.9rem; display: flex; justify-content: space-between;">
      <button onclick="clearText()" style="background: #eee; border: 1px solid #ccc; border-radius: 6px;">クリア</button>
      <div style="flex: 1"></div>
      <button onclick="copyText()" style="background: #7AA6A8; color: #fff; border: none; border-radius: 6px;">コピー</button>
    </div>

    <script>
      const GAS_URL = "https://script.google.com/macros/s/AKfycbzUODweFan9H0_p3iR5mlb66xqmlmlEnzi6gcpTo-Ubf2yd04w8lkaGE2UM9JsC1-nJ/exec";
      let config = {};
      let currentTab = '';
      let currentEditIndex = null;

      /* ========== 共通: GAS IO ========== */
      function fetchConfigFromGAS(){
        return fetch(GAS_URL).then(r=>r.json()).then(data=>{
          const next = {};
          for(const k in data){ next[k]=(data[k]||[]).map(row=>Array.isArray(row)?[row[0],row[1],row[2]]:row); }
          return next;
        });
      }
      function saveSheetToGAS(sheetName){
        return fetch(GAS_URL,{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ sheetName, data: JSON.stringify(config[sheetName]||[]) })
        });
      }
      function createEmptySheetOnGAS(sheetName){
        // GAS 側が未作成ならこの POST で作る想定（同じエンドポイント）
        return fetch(GAS_URL,{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ sheetName, data: JSON.stringify([]) })
        });
      }

      /* ========== タブ & ボタン ========== */
      function renderTabs() {
        const tabContainer = document.getElementById('tabs');
        tabContainer.innerHTML = '';
        Object.keys(config).forEach(group => {
          const tab = document.createElement('div');
          tab.className = 'tab' + (group === currentTab ? ' active' : '');
          tab.textContent = group;
          tab.onclick = () => { currentTab = group; renderTabs(); renderButtons(); };
          tabContainer.appendChild(tab);
        });
      }
      function renderButtons() {
        const modal = document.getElementById('modal');
        if (modal) modal.style.display = 'none';

        const btnContainer = document.getElementById('buttons');
        btnContainer.innerHTML = '';
        (config[currentTab] || []).forEach((row, index) => {
          const label = row[0], content = row[1], color = row[2] || '#f9f9f9';

          const wrapper = document.createElement('div');
          wrapper.className = 'button-wrapper';

          const btn = document.createElement('button');
          btn.className = 'button-main';
          btn.style.background = color;
          btn.innerHTML = `<span class='label'>${label}</span><span class='content'>${content.replace(/\n/g,'<br>')}</span>`;

          const expandIcon = document.createElement('span');
          expandIcon.className = 'expand-icon';
          expandIcon.textContent = '▼';
          btn.appendChild(expandIcon);

          btn.onclick = () => insertText(content);

          const menuBtn = document.createElement('button');
          menuBtn.className = 'menu-button';
          menuBtn.textContent = '…';
          menuBtn.onclick = (e) => {
            e.stopPropagation(); currentEditIndex = index;
            document.getElementById('editLabel').value = label;
            document.getElementById('editContent').value = content;
            document.getElementById('editColor').value = color;
            renderColorPalette(color);
            document.getElementById('modal').style.display = 'flex';
          };

          wrapper.appendChild(menuBtn);
          wrapper.appendChild(btn);
          btnContainer.appendChild(wrapper);
        });
      }

      /* ========== エディタ操作 ========== */
      function insertText(text){ const e=document.getElementById('editor'); e.value += (e.value?'\n\n':'') + text; }
      function copyText(){
        const t=document.getElementById('editor').value;
        if(!navigator.clipboard){ alert('コピーできませんでした'); return; }
        navigator.clipboard.writeText(t).then(()=>{
          const msg=document.createElement('div');
          msg.textContent='コピーしました！';
          Object.assign(msg.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#333',color:'#fff',padding:'0.6rem 1rem',borderRadius:'6px',zIndex:10000,fontSize:'14px'});
          document.body.appendChild(msg); setTimeout(()=>msg.remove(),1500);
        });
      }
      function clearText(){ document.getElementById('editor').value=''; }
      function closeModal(){ document.getElementById('modal').style.display='none'; }

      /* ========== テンプレ保存/削除 ========== */
      async function saveEdit(){
        const l=document.getElementById('editLabel').value.trim(),
              c=document.getElementById('editContent').value,
              col=document.getElementById('editColor').value;
        if(!l){ alert('ラベルは必須です'); return; }
        if(!currentTab){ alert('先にカテゴリを作成してください'); return; }
        if(!config[currentTab]) config[currentTab]=[];
        if(currentEditIndex!==null) config[currentTab][currentEditIndex]=[l,c,col];
        else config[currentTab].push([l,c,col]);

        renderButtons(); closeModal();
        await saveSheetToGAS(currentTab).catch(()=>alert('保存エラー'));
        // サーバ確定を再読込で反映
        config = await fetchConfigFromGAS().catch(()=>config);
        renderTabs(); renderButtons();
      }
      async function deleteTemplate(){
        if(currentEditIndex!==null && confirm('このテンプレートを削除しますか？')){
          config[currentTab].splice(currentEditIndex,1);
          renderButtons(); closeModal();
          await saveSheetToGAS(currentTab).catch(()=>alert('削除保存エラー'));
          config = await fetchConfigFromGAS().catch(()=>config);
          renderTabs(); renderButtons();
        }
      }

      /* ========== カテゴリ追加 ========== */
      function sanitizeSheetName(name){ return name.replace(/[:\\/?*\\[\\]]/g,'').trim(); }
      async function addNewCategory(){
        let name = prompt('新しいカテゴリ名を入力してください（例：お詫び/遅延）');
        if(name===null) return;
        name = sanitizeSheetName(name);
        if(!name){ alert('カテゴリ名が空です'); return; }
        if(config[name]){ alert('同名のカテゴリがあります'); return; }

        // 先にローカル作成してUXを早く
        config[name]=[];
        currentTab=name;
        renderTabs(); renderButtons();

        // シート作成（GAS 側が新規タブ作成に対応していれば作られる想定）
        await createEmptySheetOnGAS(name).catch(()=>alert('カテゴリ作成エラー'));

        // 念のためサーバ状態を再読込（ここで本当に作られたか確認）
        config = await fetchConfigFromGAS().catch(()=>config);
        if(!config[name]){ config[name]=[]; } // 失敗時もローカル維持
        currentTab = name;
        renderTabs(); renderButtons();
      }

      /* ========== カラーパレット ========== */
      function renderColorPalette(selected){
        const palette=['#DCEBF2','#F3D8D5','#FAE3E1','#E9D8C9','#F8EDEB','#D6E2E9','#E3DFFF','#D8EBD8','#FFF3D6','#FAD2CF'];
        const container=document.getElementById('colorPalette');
        container.innerHTML='';
        palette.forEach(col=>{
          const d=document.createElement('div');
          d.className='swatch'+(col===selected?' active':'');
          d.style.background=col;
          d.title=col;
          d.onclick=()=>{ document.getElementById('editColor').value=col; renderColorPalette(col); };
          container.appendChild(d);
        });
      }

      /* ========== 初期ロード ========== */
      (async function init(){
        try{
          config = await fetchConfigFromGAS();
        }catch(e){
          alert('読み込みエラー: '+e);
          config = { '未分類': [] };
        }
        if(Object.keys(config).length===0) config['未分類']=[];
        currentTab = Object.keys(config)[0];
        renderTabs(); renderButtons();
      })();

      /* ========== リサイズ（ボタン領域） ========== */
      document.addEventListener('DOMContentLoaded',()=>{
        const resizer=document.querySelector('.resizer');
        const container=document.querySelector('.buttons-container');
        let startY,startHeight;
        resizer.addEventListener('mousedown',e=>{
          startY=e.clientY; startHeight=parseInt(getComputedStyle(container).height,10);
          document.documentElement.addEventListener('mousemove',doDrag);
          document.documentElement.addEventListener('mouseup',stopDrag);
        });
        function doDrag(e){ container.style.maxHeight=`${startHeight+e.clientY-startY}px`; }
        function stopDrag(){ document.documentElement.removeEventListener('mousemove',doDrag); document.documentElement.removeEventListener('mouseup',stopDrag); }
      });

      /* ========== ＋サブメニュー（ポータル表示） ========== */
      (function setupPlusMenu(){
        const btn = document.getElementById('plusBtn');

        // メニュー本体は body 直下に作る（overflow の影響を受けない）
        const menu = document.createElement('div');
        menu.id = 'plusMenu';
        menu.className = 'plus-menu';
        menu.innerHTML = `
          <button class="plus-item" role="menuitem" id="miAddTpl">テンプレートを追加</button>
          <button class="plus-item" role="menuitem" id="miAddCat">カテゴリを追加</button>
        `;
        document.body.appendChild(menu);

        function openMenu(){
          const r = btn.getBoundingClientRect();
          // 右寄せでボタンの下に固定配置
          const menuWidth = 190; // だいたい
          const left = Math.max(12, r.right - menuWidth);
          const top  = r.bottom + 6;
          menu.style.left = left + 'px';
          menu.style.top  = top  + 'px';
          menu.style.width = menuWidth + 'px';
          menu.classList.add('show');
          btn.setAttribute('aria-expanded','true');
        }
        function closeMenu(){
          menu.classList.remove('show');
          btn.setAttribute('aria-expanded','false');
        }
        window.closePlusMenu = closeMenu;

        btn.addEventListener('click',(e)=>{ e.stopPropagation(); menu.classList.contains('show') ? closeMenu() : openMenu(); });
        document.addEventListener('click',(e)=>{ if(menu.classList.contains('show') && !e.target.closest('#plusMenu')) closeMenu(); });
        document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeMenu(); });

        // メニュー項目
        menu.querySelector('#miAddTpl').addEventListener('click',()=>{ addNewTemplate(); closeMenu(); });
        menu.querySelector('#miAddCat').addEventListener('click',()=>{ addNewCategory(); closeMenu(); });
      })();

      /* ========== 新規テンプレ起動 ========== */
      function addNewTemplate(){
        if(!currentTab){
          alert('まずカテゴリを作成してください');
          return;
        }
        currentEditIndex = null;
        document.getElementById('editLabel').value='';
        document.getElementById('editContent').value='';
        document.getElementById('editColor').value='#f9f9f9';
        renderColorPalette('#f9f9f9');
        document.getElementById('modal').style.display='flex';
      }
    </script>

    <!-- 編集モーダル -->
    <div id="modal" class="modal" onclick="closeModal()" style="display:none; position: fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
      <div class="modal-content" style="background:white; padding:1rem; border-radius:8px; width:320px; display:flex; flex-direction:column; gap:0.6rem; position:relative;" onclick="event.stopPropagation();">
        <input id="editLabel" placeholder="ラベル">
        <textarea id="editContent" rows="4" placeholder="内容"></textarea>
        <div class="palette" id="colorPalette"></div>
        <input type="color" id="editColor" value="#f9f9f9" style="width:32px; height:32px; border:none; border-radius:50%; cursor:pointer;">

        <div style="display:flex; justify-content:space-between; align-items:center;">
          <button class="delete-btn" onclick="deleteTemplate()" title="削除">🗑️</button>
          <div style="display:flex; gap:0.5rem;">
            <button onclick="closeModal()">キャンセル</button>
            <button onclick="saveEdit()">保存</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
