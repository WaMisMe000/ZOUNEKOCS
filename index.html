<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ÂÆöÂûãÊñá„É©„É≥„ÉÅ„É£„Éº</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; background-color: #F4F4F6; }
    #tabs { display: flex; gap: 0.3rem; flex: 1; }
    .tabs { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 0.3rem; padding: 0.2rem 0; margin-bottom: 0.5rem; align-items: center; width: 100%; scrollbar-width: thin; scrollbar-color: #ccc transparent; flex-shrink: 0; }
    .tab { background-color: white; white-space: nowrap; padding: 0.3rem 0.8rem; border: 1px solid #ccc; cursor: pointer; border-radius: 6px; font-size: 14px; }
    .tab.active { background: #7AA6A8; color: #fff; font-weight: bold; }
    .buttons { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem; margin-bottom: 1rem; }
    .button-wrapper { position: relative; overflow: hidden; }
    .button-main { background-color: #FDFDFE; border: 1px solid #ccc; padding: 0.6rem 0.8rem; border-radius: 6px; width: 100%; font-size: 13px; cursor: pointer; text-align: left; transition: all 0.2s ease-in-out; position: relative; overflow: hidden; }
    .button-main .content { font-size: 12px; color: #777; margin-top: 2px; line-height: 1.2em; display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; max-height: 3.6em; -webkit-line-clamp: 3; min-height: 3.6em; }
    .button-main.expanded .content { max-height: none; -webkit-line-clamp: unset; white-space: normal; }
    .button-main .expand-icon { font-size: 10px; color: #999; position: absolute; right: 6px; bottom: 6px; pointer-events: none; }
    .actions { margin-top: 1rem; display: flex; gap: 1rem; }
    .actions button { padding: 0.5rem 1rem; font-size: 14px; cursor: pointer; }
    textarea { width: 100%; height: 280px; font-size: 14px; padding: 1rem; box-sizing: border-box; resize: none; }
    .menu-button { position: absolute; top: 4px; right: 4px; background: none; border: none; cursor: pointer; font-size: 16px; color: #999; z-index: 1; }
    .menu-button:hover { color: #333; }
    .tab.new-tab { flex-shrink: 0; background-color: #7AA6A8; color: white; font-weight: bold; font-size: 17px; padding: 0.2em 0.4em; border-radius: 6px; border: none; cursor: pointer; }

    /* „Éë„É¨„ÉÉ„Éà */
    .palette { display: flex; gap: 4px; align-items: center; flex-wrap: nowrap; }
    .swatch { width: 28px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 0 0 1px rgba(0,0,0,0.06) inset; }
    .swatch.active { border-color: #333; }

    .delete-btn { background: none; border: none; color: #c00; cursor: pointer; font-size: 18px; }
    .delete-btn:hover { color: #900; }
  </style>
</head>
<body>
  <div style="display: flex; flex-direction: column; gap: 1rem; max-height: 80vh;">
   <div class="tabs" id="tabs-wrapper">
  <div id="tabs"></div>
  <!-- üëá ËøΩÂä†Ôºö„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†„Éú„Çø„É≥ -->
  <button onclick="addNewCategory()" class="tab new-tab">Ôºã„Ç´„ÉÜ„Ç¥„É™</button>
  <!-- Êó¢Â≠òÔºö„ÉÜ„É≥„Éó„É¨ËøΩÂä†„Éú„Çø„É≥ -->
  <button onclick="addNewTemplate()" class="tab new-tab">Ôºã</button>
</div>

    <div class="buttons-resizable" style="position: relative;">
      <div class="buttons-container" style="flex: 1; overflow-y: auto; max-height: calc(3.6em * 3 + 2rem); margin-bottom: 0.5rem;">
        <div class="buttons" id="buttons"></div>
      </div>
      <div class="resizer" style="height: 2px; cursor: row-resize; background: #7AA6A8; margin: 12px 0;"></div>
    </div>

    <div class="editor-container" style="position: relative; top: -18px;">
      <textarea id="editor" placeholder="„Åì„Åì„Å´ÂÆöÂûãÊñá„ÅåËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åç„Åæ„Åô..." style="height: 420px;"></textarea>
      <div class="editor-resizer" style="height: 2px; background: #7AA6A8; cursor: row-resize; margin: 12px 0;"></div>
    </div>

    <div class="actions" style="margin-top: -0.9rem; display: flex; justify-content: space-between;">
      <button onclick="clearText()" style="background: #eee; border: 1px solid #ccc; border-radius: 6px;">„ÇØ„É™„Ç¢</button>
      <div style="flex: 1"></div>
      <button onclick="copyText()" style="background: #7AA6A8; color: #fff; border: none; border-radius: 6px;">„Ç≥„Éî„Éº</button>
    </div>

    <script>
      const GAS_URL = "https://script.google.com/macros/s/AKfycbwo54UieUNE2vII8oaDfJ9a69-FuZlrKCe4cR_CXJO_Xdge7TGowNMuZvAsyE5AgekUeQ/exec";
      let config = {}; let currentTab = ''; let currentEditIndex = null;

      function renderTabs() {
        const tabContainer = document.getElementById('tabs');
        tabContainer.innerHTML = '';
        Object.keys(config).forEach(group => {
          const tab = document.createElement('div');
          tab.className = 'tab' + (group === currentTab ? ' active' : '');
          tab.textContent = group;
          tab.onclick = () => { currentTab = group; renderTabs(); renderButtons(); };
          tabContainer.appendChild(tab);
        });
      }

      function renderButtons() {
        document.getElementById('modal').style.display = 'none';
        const btnContainer = document.getElementById('buttons');
        btnContainer.innerHTML = '';
        (config[currentTab] || []).forEach((row, index) => {
          const label = row[0], content = row[1], color = row[2] || '#f9f9f9';
          const wrapper = document.createElement('div');
          wrapper.className = 'button-wrapper';
          const btn = document.createElement('button');
          btn.className = 'button-main';
          btn.style.background = color;
          btn.innerHTML = `<span class='label'>${label}</span><span class='content'>${content.replace(/\n/g,'<br>')}</span>`;
          const expandIcon = document.createElement('span');
          expandIcon.className = 'expand-icon'; expandIcon.textContent = '‚ñº';
          btn.appendChild(expandIcon);
          btn.onclick = () => insertText(content);
          const menuBtn = document.createElement('button');
          menuBtn.className = 'menu-button';
          menuBtn.textContent = '‚Ä¶';
          menuBtn.onclick = (e) => {
            e.stopPropagation(); currentEditIndex = index;
            document.getElementById('editLabel').value = label;
            document.getElementById('editContent').value = content;
            document.getElementById('editColor').value = color;
            renderColorPalette(color);
            updatePreview(color);
            document.getElementById('modal').style.display = 'flex';
          };
          wrapper.appendChild(menuBtn);
          wrapper.appendChild(btn);
          btnContainer.appendChild(wrapper);
        });
      }

      function insertText(text){const e=document.getElementById('editor');e.value+=(e.value?'\n\n':'')+text;}
      function copyText(){
        const t=document.getElementById('editor').value;
        if(!navigator.clipboard){alert('„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');return;}
        navigator.clipboard.writeText(t).then(()=>{
          const msg=document.createElement('div');
          msg.textContent='„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ';
          Object.assign(msg.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#333',color:'#fff',padding:'0.6rem 1rem',borderRadius:'6px',zIndex:10000,fontSize:'14px'});
          document.body.appendChild(msg); setTimeout(()=>msg.remove(),1500);
        });
      }
      function clearText(){document.getElementById('editor').value='';}
      function closeModal(){document.getElementById('modal').style.display='none';}

      function saveEdit(){
        const l=document.getElementById('editLabel').value,
              c=document.getElementById('editContent').value,
              col=document.getElementById('editColor').value;
        if(!config[currentTab])config[currentTab]=[];
        if(currentEditIndex!==null)config[currentTab][currentEditIndex]=[l,c,col]; else config[currentTab].push([l,c,col]);
        renderButtons(); closeModal(); saveToGAS();
      }

      function deleteTemplate(){
        if(currentEditIndex!==null && confirm('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')){
          config[currentTab].splice(currentEditIndex,1);
          renderButtons(); closeModal(); saveToGAS();
        }
      }

      function saveToGAS(){
        fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({sheetName:currentTab,data:JSON.stringify(config[currentTab])})});
      }

      function renderColorPalette(selected){
        const palette=['#DCEBF2','#F3D8D5','#FAE3E1','#E9D8C9','#F8EDEB','#D6E2E9','#E3DFFF','#D8EBD8','#FFF3D6','#FAD2CF'];
        const container=document.getElementById('colorPalette');
        container.innerHTML='';
        palette.forEach(col=>{
          const d=document.createElement('div');
          d.className='swatch'+(col===selected?' active':'');
          d.style.background=col;
          d.title=col;
          d.onclick=()=>{ document.getElementById('editColor').value=col; renderColorPalette(col); updatePreview(col); };
          container.appendChild(d);
        });
      }
      function updatePreview(col){ document.getElementById('colorPreview').style.background=col; }

      // ÂàùÊúü„É≠„Éº„Éâ
      fetch(GAS_URL)
        .then(r=>r.json())
        .then(data=>{
          config={};
          for(const k in data){ config[k]=(data[k]||[]).map(row=>Array.isArray(row)?[row[0],row[1],row[2]]:row); }
          currentTab=Object.keys(config)[0];
          renderTabs(); renderButtons();
        })
        .catch(err=>alert('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: '+err));

      // „É™„Çµ„Ç§„Ç∫Ôºà„Éú„Çø„É≥È†òÂüüÔºâ
      document.addEventListener('DOMContentLoaded',()=>{
        const resizer=document.querySelector('.resizer');
        const container=document.querySelector('.buttons-container');
        let startY,startHeight;
        resizer.addEventListener('mousedown',e=>{startY=e.clientY;startHeight=parseInt(getComputedStyle(container).height,10);document.documentElement.addEventListener('mousemove',doDrag);document.documentElement.addEventListener('mouseup',stopDrag);});
        function doDrag(e){container.style.maxHeight=`${startHeight+e.clientY-startY}px`;}
        function stopDrag(){document.documentElement.removeEventListener('mousemove',doDrag);document.documentElement.removeEventListener('mouseup',stopDrag);}        
      });

      function addNewTemplate(){
        currentEditIndex=null;
        document.getElementById('editLabel').value='';
        document.getElementById('editContent').value='';
        document.getElementById('editColor').value='#f9f9f9';
        renderColorPalette('#f9f9f9');
        updatePreview('#f9f9f9');
        document.getElementById('modal').style.display='flex';
      }

      function sanitizeSheetName(name) {
    return name.replace(/[:\\/?*\[\]]/g, '').trim();
  }

  function addNewCategory() {
    let name = prompt('Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æãÔºö„ÅäË©´„Å≥/ÈÅÖÂª∂Ôºâ');
    if (name === null) return; // „Ç≠„É£„É≥„Çª„É´
    name = sanitizeSheetName(name);
    if (!name) { alert('„Ç´„ÉÜ„Ç¥„É™Âêç„ÅåÁ©∫„Åß„Åô'); return; }

    if (config[name]) { alert('ÂêåÂêç„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅåÊó¢„Å´„ÅÇ„Çä„Åæ„Åô'); return; }

    // Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™ÔºàÔºù„Ç∑„Éº„ÉàÔºâ„Çí„É≠„Éº„Ç´„É´„Å´‰ΩúÊàê
    config[name] = [];

    // „ÅÑ„Å£„Åü„Çì„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„ÇíÊñ∞„Ç´„ÉÜ„Ç¥„É™„Å´
    currentTab = name;

    // ÁîªÈù¢Êõ¥Êñ∞
    renderTabs();
    renderButtons();

    // GAS„Å´Á©∫„Éá„Éº„Çø„ÅßPOSTÔºà„Çµ„Éº„ÉêÂÅ¥„ÅßÊú™‰ΩúÊàê„Å™„Çâ„Ç∑„Éº„Éà‰ΩúÊàê„ÇíÊÉ≥ÂÆöÔºâ
    saveEmptySheetToGAS(name)
      .then(() => showToast('„Ç´„ÉÜ„Ç¥„É™„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü'))
      .catch(err => alert('„Ç´„ÉÜ„Ç¥„É™‰ΩúÊàê„Ç®„É©„Éº: ' + err));
  }

  // „Éà„Éº„Çπ„ÉàÔºà‰ªªÊÑèÔºâ
  function showToast(text){
    const msg = document.createElement('div');
    msg.textContent = text;
    Object.assign(msg.style, {
      position:'fixed', bottom:'20px', left:'50%', transform:'translateX(-50%)',
      background:'#333', color:'#fff', padding:'0.6rem 1rem', borderRadius:'6px',
      zIndex:10000, fontSize:'14px'
    });
    document.body.appendChild(msg); setTimeout(()=>msg.remove(), 1500);
  }

  // ÊåáÂÆö„Ç∑„Éº„ÉàÂêç„Å´Á©∫ÈÖçÂàó„Çí‰øùÂ≠òÔºàÔºù„Ç∑„Éº„Éà‰ΩúÊàê„Éà„É™„Ç¨Ôºâ
  function saveEmptySheetToGAS(sheetName) {
    return fetch(GAS_URL, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({
        sheetName: sheetName,
        data: JSON.stringify([])   // üëà Á©∫„ÅßÈÄÅ„Çã
      })
    }).then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.text();
    });
  }
      
    </script>

    <div id="modal" class="modal" onclick="closeModal()" style="display:none; position: fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
      <div class="modal-content" style="background:white; padding:1rem; border-radius:8px; width:320px; display:flex; flex-direction:column; gap:0.6rem; position:relative;" onclick="event.stopPropagation();">
        <input id="editLabel" placeholder="„É©„Éô„É´">
        <textarea id="editContent" rows="4" placeholder="ÂÜÖÂÆπ"></textarea>

        <!-- „Éë„É¨„ÉÉ„ÉàË°å -->
        <div class="palette" id="colorPalette"></div>
        <input type="color" id="editColor" value="#f9f9f9" style="width: 32px; height: 32px; border: none; border-radius: 50%; cursor: pointer;" onchange="updatePreview(this.value); renderColorPalette(this.value)">

        <div style="display:flex; justify-content:space-between; align-items:center;">
          <button class="delete-btn" onclick="deleteTemplate()" title="ÂâäÈô§">üóëÔ∏è</button>
          <div style="display:flex; gap:0.5rem;">
            <button onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
            <button onclick="saveEdit()">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>


